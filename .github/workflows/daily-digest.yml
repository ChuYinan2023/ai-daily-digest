name: Daily Digest

on:
  schedule:
    # UTC 0:00 = Beijing 8:00 AM
    - cron: '0 0 * * *'
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js (for Puppeteer)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Chinese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-color-emoji

      - name: Install Puppeteer
        run: |
          npm install puppeteer
          npx puppeteer browsers install chrome

      - name: Generate digest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          DATE=$(date -u +%Y%m%d)
          mkdir -p digests
          bun scripts/digest.ts \
            --hours 48 \
            --top-n 15 \
            --lang zh \
            --wechat \
            --output "digests/digest-${DATE}.md"

      - name: Screenshot cover image
        run: |
          DATE=$(date -u +%Y%m%d)
          COVER_HTML="digests/digest-${DATE}-cover.html"
          if [ -f "$COVER_HTML" ]; then
            bun scripts/screenshot-cover.ts "$COVER_HTML" "digests/digest-${DATE}-cover.png"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add digests/
          # Only commit if there are changes
          git diff --cached --quiet || git commit -m "chore: add daily digest $(date -u +%Y-%m-%d)"
          git push
